[metadata]
query_id = 14
modalities = ["image", "text", "tabular"]
required_operators = ["SEMANTIC_JOIN", "SEMANTIC_FILTER", "SEMANTIC_RANKING"]
description = """
Image reconciliation: Find the original image for a product based on the product description.

The query contains a SEMANTIC_JOIN and a SEMANTIC_RANKING operator that both work together via the GROUP_BY.
Combining both into one operator might be a good optimization.

Contains a SEMANTIC_FILTER with two implicit conditions: 'white' and 'socks'.
Both might be individually evaluated based on title or description instead of the image.

There is also a classic SQL filter on one side of the join and a semantic filter on the other side.
This might be a good example for join ordering and cardinality estimation.
"""


[definition]
# For systems that accept free-text queries
natural_language = """
For each fashion product that costs less than 130,
find the single image that best matches the product's textual description
(including the product name and full description),
but only if that image also depicts white socks.
"""

# Equivalent to the natural language query
sql = """
SELECT
  ARRAY_AGG(
    images.id
    ORDER BY AI.SCORE('The image ' || images.image || ' fits the description: ' || styles_details.productDisplayName || ' ' || styles_details.productDescriptors.description)
    LIMIT 1
  )[0] AS image_id
FROM styles_details
JOIN images
  ON AI.IF('The image ' || images.image || ' fits the description: ' || styles_details.productDisplayName || ' ' || styles_details.productDescriptors.description)
WHERE styles_details.price < 130
  AND AI.IF('The image ' || images.image || ' depicts white socks')
GROUP BY styles_details.id, styles_details.productDisplayName, styles_details.productDescriptors.description
"""

# Traditional SQL query to compute the exact result on the non-omitted data.
ground_truth = """
SELECT id as id
FROM read_parquet('styles_details.parquet') as styles_details
WHERE styles_details.articleType.typeName = 'Socks'
  AND styles_details.baseColour = 'White'
  AND styles_details.price < 130
;
"""
# Which accuracy metric to use for evaluation
accuracy_metric = "f1-score"
